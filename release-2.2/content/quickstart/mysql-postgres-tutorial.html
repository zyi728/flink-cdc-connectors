

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Streaming ETL for MySQL and Postgres with Flink CDC &mdash; CDC Connectors for Apache Flink®  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Demo: MongoDB CDC to Elasticsearch" href="mongodb-tutorial.html" />
    <link rel="prev" title="Getting Started" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> CDC Connectors for Apache Flink®
          

          
          </a>

          
            
            
              <div class="version">
                release-2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Getting Started</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Streaming ETL for MySQL and Postgres with Flink CDC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preparation">Preparation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#starting-components-required">Starting components required</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparing-flink-and-jar-package-required">Preparing Flink and JAR package required</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparing-data-in-databases">Preparing data in databases</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#starting-flink-cluster-and-flink-sql-cli">Starting Flink cluster and Flink SQL CLI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-tables-using-flink-ddl-in-flink-sql-cli">Creating tables using Flink DDL in Flink SQL CLI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#enriching-orders-and-load-to-elasticsearch">Enriching orders and load to ElasticSearch</a></li>
<li class="toctree-l3"><a class="reference internal" href="#clean-up">Clean up</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mongodb-tutorial.html">Demo: MongoDB CDC to Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="oceanbase-tutorial.html">Demo: OceanBase CDC to ElasticSearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="oracle-tutorial.html">Demo: Oracle CDC to Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="polardbx-tutorial.html">Demo: PolarDB-X CDC to Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="sqlserver-tutorial.html">Demo: SqlServer CDC to Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="tidb-tutorial.html">Demo: TiDB CDC to Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-real-time-data-lake-tutorial.html">Using Flink CDC to synchronize data from MySQL sharding tables and build real-time data lake</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/index.html">快速上手</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connectors/index.html">Connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../formats/index.html">Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../downloads.html">Downloads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../githublink.html"><a class="github-button" href="https://github.com/ververica/flink-cdc-connectors" data-color-scheme="no-preference: dark_high_contrast; light: dark_high_contrast; dark: dark_high_contrast;" data-size="large" data-show-count="true" aria-label="Star ververica/flink-cdc-connectors on GitHub">Star</a></a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CDC Connectors for Apache Flink®</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
-->

<!-- Extend the RTD template to support user defined "Edit on Github" URL -->

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Getting Started</a> &raquo;</li>
        
      <li>Streaming ETL for MySQL and Postgres with Flink CDC</li>
    
    
            <li class="wy-breadcrumbs-aside">
                
                    
                        <a href="http://github.com/ververica/flink-cdc-connectors/blob/release-2.2/docs/content/quickstart/mysql-postgres-tutorial.md" class="fa fa-github"> Edit on GitHub</a>
                    
                
            </li>
        
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section class="tex2jax_ignore mathjax_ignore" id="streaming-etl-for-mysql-and-postgres-with-flink-cdc">
<h1>Streaming ETL for MySQL and Postgres with Flink CDC<a class="headerlink" href="#streaming-etl-for-mysql-and-postgres-with-flink-cdc" title="Permalink to this headline">¶</a></h1>
<p>This tutorial is to show how to quickly build streaming ETL for MySQL and Postgres with Flink CDC.</p>
<p>Assuming we are running an e-commerce business. The product and order data stored in MySQL, the shipment data related to the order is stored in Postgres.
We want to enrich the orders using the product and shipment table, and then load the enriched orders to ElasticSearch in real time.</p>
<p>In the following sections, we will describe how to use Flink Mysql/Postgres CDC to implement it.
All exercises in this tutorial are performed in the Flink SQL CLI, and the entire process uses standard SQL syntax, without a single line of Java/Scala code or IDE installation.</p>
<p>The overview of the architecture is as follows:
<img alt="Flink CDC Streaming ETL" src="../../_images/flink-cdc-streaming-etl.png" /></p>
<section id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">¶</a></h2>
<p>Prepare a Linux or MacOS computer with Docker installed.</p>
<section id="starting-components-required">
<h3>Starting components required<a class="headerlink" href="#starting-components-required" title="Permalink to this headline">¶</a></h3>
<p>The components required in this demo are all managed in containers, so we will use <code class="docutils literal notranslate"><span class="pre">docker-compose</span></code> to start them.</p>
<p>Create <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code> file using following contents:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;2.1&#39;</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">postgres</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">debezium</span><span class="o">/</span><span class="n">example</span><span class="o">-</span><span class="n">postgres</span><span class="p">:</span><span class="mf">1.1</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;5432:5432&quot;</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">POSTGRES_DB</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_USER</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
  <span class="n">mysql</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">debezium</span><span class="o">/</span><span class="n">example</span><span class="o">-</span><span class="n">mysql</span><span class="p">:</span><span class="mf">1.1</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;3306:3306&quot;</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">MYSQL_ROOT_PASSWORD</span><span class="o">=</span><span class="mi">123456</span>
      <span class="o">-</span> <span class="n">MYSQL_USER</span><span class="o">=</span><span class="n">mysqluser</span>
      <span class="o">-</span> <span class="n">MYSQL_PASSWORD</span><span class="o">=</span><span class="n">mysqlpw</span>
  <span class="n">elasticsearch</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">elastic</span><span class="o">/</span><span class="n">elasticsearch</span><span class="p">:</span><span class="mf">7.6.0</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">cluster</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">docker</span><span class="o">-</span><span class="n">cluster</span>
      <span class="o">-</span> <span class="n">bootstrap</span><span class="o">.</span><span class="n">memory_lock</span><span class="o">=</span><span class="n">true</span>
      <span class="o">-</span> <span class="s2">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span>
      <span class="o">-</span> <span class="n">discovery</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="n">single</span><span class="o">-</span><span class="n">node</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;9200:9200&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;9300:9300&quot;</span>
    <span class="n">ulimits</span><span class="p">:</span>
      <span class="n">memlock</span><span class="p">:</span>
        <span class="n">soft</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">hard</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
      <span class="n">nofile</span><span class="p">:</span>
        <span class="n">soft</span><span class="p">:</span> <span class="mi">65536</span>
        <span class="n">hard</span><span class="p">:</span> <span class="mi">65536</span>
  <span class="n">kibana</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">elastic</span><span class="o">/</span><span class="n">kibana</span><span class="p">:</span><span class="mf">7.6.0</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;5601:5601&quot;</span>
</pre></div>
</div>
<p>The Docker Compose environment consists of the following containers:</p>
<ul class="simple">
<li><p>MySQL: the <code class="docutils literal notranslate"><span class="pre">products</span></code>,<code class="docutils literal notranslate"><span class="pre">orders</span></code> tables will be store in the database. They will be joined with data in Postgres to enrich the orders.</p></li>
<li><p>Postgres: the <code class="docutils literal notranslate"><span class="pre">shipments</span></code> table will be store in the database.</p></li>
<li><p>Elasticsearch: mainly used as a data sink to store enriched orders.</p></li>
<li><p>Kibana: used to visualize the data in Elasticsearch.</p></li>
</ul>
<p>To start all containers, run the following command in the directory that contains the <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code> file.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker-compose up -d
</pre></div>
</div>
<p>This command automatically starts all the containers defined in the Docker Compose configuration in a detached mode. Run docker ps to check whether these containers are running properly.
We can also visit <a class="reference external" href="http://localhost:5601/">http://localhost:5601/</a> to see if Kibana is running normally.</p>
</section>
<section id="preparing-flink-and-jar-package-required">
<h3>Preparing Flink and JAR package required<a class="headerlink" href="#preparing-flink-and-jar-package-required" title="Permalink to this headline">¶</a></h3>
<ol>
<li><p>Download <a class="reference external" href="https://archive.apache.org/dist/flink/flink-1.13.2/flink-1.13.2-bin-scala_2.11.tgz">Flink 1.13.2</a> and unzip it to the directory <code class="docutils literal notranslate"><span class="pre">flink-1.13.2</span></code></p></li>
<li><p>Download following JAR package required and put them under <code class="docutils literal notranslate"><span class="pre">flink-1.13.2/lib/</span></code>:</p>
<p>**Download links are available only for stable releases, SNAPSHOT dependency need build by yourself. **</p>
<ul class="simple">
<li><p><a class="reference external" href="https://repo.maven.apache.org/maven2/org/apache/flink/flink-sql-connector-elasticsearch7_2.11/1.13.2/flink-sql-connector-elasticsearch7_2.11-1.13.2.jar">flink-sql-connector-elasticsearch7_2.11-1.13.2.jar</a></p></li>
<li><p><a class="reference external" href="https://repo1.maven.org/maven2/com/ververica/flink-sql-connector-mysql-cdc/2.2.0/flink-sql-connector-mysql-cdc-2.2.0.jar">flink-sql-connector-mysql-cdc-2.2.0.jar</a></p></li>
<li><p><a class="reference external" href="https://repo1.maven.org/maven2/com/ververica/flink-sql-connector-postgres-cdc/2.2.0/flink-sql-connector-postgres-cdc-2.2.0.jar">flink-sql-connector-postgres-cdc-2.2.0.jar</a></p></li>
</ul>
</li>
</ol>
</section>
<section id="preparing-data-in-databases">
<h3>Preparing data in databases<a class="headerlink" href="#preparing-data-in-databases" title="Permalink to this headline">¶</a></h3>
<section id="preparing-data-in-mysql">
<h4>Preparing data in MySQL<a class="headerlink" href="#preparing-data-in-mysql" title="Permalink to this headline">¶</a></h4>
<ol>
<li><p>Enter mysql’s container:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker-compose <span class="nb">exec</span> mysql mysql -uroot -p123456
</pre></div>
</div>
</li>
<li><p>Create tables and populate data:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- MySQL</span>
<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">mydb</span><span class="p">;</span>
<span class="n">USE</span> <span class="n">mydb</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="p">(</span>
  <span class="n">id</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">description</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="n">AUTO_INCREMENT</span> <span class="o">=</span> <span class="mi">101</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">products</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="ss">&quot;scooter&quot;</span><span class="p">,</span><span class="ss">&quot;Small 2-wheel scooter&quot;</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="ss">&quot;car battery&quot;</span><span class="p">,</span><span class="ss">&quot;12V car battery&quot;</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="ss">&quot;12-pack drill bits&quot;</span><span class="p">,</span><span class="ss">&quot;12-pack of drill bits with sizes ranging from #40 to #3&quot;</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="ss">&quot;hammer&quot;</span><span class="p">,</span><span class="ss">&quot;12oz carpenter&#39;s hammer&quot;</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="ss">&quot;hammer&quot;</span><span class="p">,</span><span class="ss">&quot;14oz carpenter&#39;s hammer&quot;</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="ss">&quot;hammer&quot;</span><span class="p">,</span><span class="ss">&quot;16oz carpenter&#39;s hammer&quot;</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="ss">&quot;rocks&quot;</span><span class="p">,</span><span class="ss">&quot;box of assorted rocks&quot;</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="ss">&quot;jacket&quot;</span><span class="p">,</span><span class="ss">&quot;water resistent black wind breaker&quot;</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="ss">&quot;spare tire&quot;</span><span class="p">,</span><span class="ss">&quot;24 inch spare tire&quot;</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">orders</span> <span class="p">(</span>
  <span class="n">order_id</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">order_date</span> <span class="n">DATETIME</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">customer_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">price</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">product_id</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">order_status</span> <span class="nb">BOOLEAN</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="c1">-- Whether order has been placed</span>
<span class="p">)</span> <span class="n">AUTO_INCREMENT</span> <span class="o">=</span> <span class="mi">10001</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">orders</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="k">default</span><span class="p">,</span> <span class="s1">&#39;2020-07-30 10:08:22&#39;</span><span class="p">,</span> <span class="s1">&#39;Jark&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">.</span><span class="mi">50</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="k">false</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span> <span class="s1">&#39;2020-07-30 10:11:09&#39;</span><span class="p">,</span> <span class="s1">&#39;Sally&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="k">false</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span> <span class="s1">&#39;2020-07-30 12:00:30&#39;</span><span class="p">,</span> <span class="s1">&#39;Edward&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">.</span><span class="mi">25</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="preparing-data-in-postgres">
<h4>Preparing data in Postgres<a class="headerlink" href="#preparing-data-in-postgres" title="Permalink to this headline">¶</a></h4>
<ol>
<li><p>Enter postgres’s container:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker-compose <span class="nb">exec</span> postgres psql -h localhost -U postgres
</pre></div>
</div>
</li>
<li><p>Create tables and populate data</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- PG</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">shipments</span> <span class="p">(</span>
  <span class="n">shipment_id</span> <span class="nb">SERIAL</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">order_id</span> <span class="nb">SERIAL</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">origin</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">destination</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">is_arrived</span> <span class="nb">BOOLEAN</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>
<span class="k">ALTER</span> <span class="n">SEQUENCE</span> <span class="k">public</span><span class="p">.</span><span class="n">shipments_shipment_id_seq</span> <span class="k">RESTART</span> <span class="k">WITH</span> <span class="mi">1001</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="k">public</span><span class="p">.</span><span class="n">shipments</span> <span class="n">REPLICA</span> <span class="k">IDENTITY</span> <span class="k">FULL</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">shipments</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="mi">10001</span><span class="p">,</span><span class="s1">&#39;Beijing&#39;</span><span class="p">,</span><span class="s1">&#39;Shanghai&#39;</span><span class="p">,</span><span class="k">false</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="mi">10002</span><span class="p">,</span><span class="s1">&#39;Hangzhou&#39;</span><span class="p">,</span><span class="s1">&#39;Shanghai&#39;</span><span class="p">,</span><span class="k">false</span><span class="p">),</span>
       <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="mi">10003</span><span class="p">,</span><span class="s1">&#39;Shanghai&#39;</span><span class="p">,</span><span class="s1">&#39;Hangzhou&#39;</span><span class="p">,</span><span class="k">false</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
</section>
<section id="starting-flink-cluster-and-flink-sql-cli">
<h2>Starting Flink cluster and Flink SQL CLI<a class="headerlink" href="#starting-flink-cluster-and-flink-sql-cli" title="Permalink to this headline">¶</a></h2>
<ol>
<li><p>Use the following command to change to the Flink directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">flink</span><span class="o">-</span><span class="mf">1.13.2</span>
</pre></div>
</div>
</li>
<li><p>Use the following command to start a Flink cluster:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./bin/start-cluster.sh
</pre></div>
</div>
<p>Then we can visit <a class="reference external" href="http://localhost:8081/">http://localhost:8081/</a> to see if Flink is running normally, and the web page looks like:</p>
<p><img alt="Flink UI" src="../../_images/flink-ui1.png" /></p>
</li>
<li><p>Use the following command to start a Flink SQL CLI:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./bin/sql-client.sh
</pre></div>
</div>
<p>We should see the welcome screen of the CLI client.</p>
<p><img alt="Flink SQL Client" src="../../_images/flink-sql-client1.png" /></p>
</li>
</ol>
</section>
<section id="creating-tables-using-flink-ddl-in-flink-sql-cli">
<h2>Creating tables using Flink DDL in Flink SQL CLI<a class="headerlink" href="#creating-tables-using-flink-ddl-in-flink-sql-cli" title="Permalink to this headline">¶</a></h2>
<p>First, enable checkpoints every 3 seconds</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Flink SQL                   </span>
<span class="n">Flink</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">SET</span> <span class="n">execution</span><span class="p">.</span><span class="n">checkpointing</span><span class="p">.</span><span class="nb">interval</span> <span class="o">=</span> <span class="mi">3</span><span class="n">s</span><span class="p">;</span>
</pre></div>
</div>
<p>Then, create tables that capture the change data from the corresponding database tables.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Flink SQL</span>
<span class="n">Flink</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">products</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INT</span><span class="p">,</span>
    <span class="n">name</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="n">description</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">NOT</span> <span class="n">ENFORCED</span>
  <span class="p">)</span> <span class="k">WITH</span> <span class="p">(</span>
    <span class="s1">&#39;connector&#39;</span> <span class="o">=</span> <span class="s1">&#39;mysql-cdc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hostname&#39;</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="s1">&#39;port&#39;</span> <span class="o">=</span> <span class="s1">&#39;3306&#39;</span><span class="p">,</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
    <span class="s1">&#39;password&#39;</span> <span class="o">=</span> <span class="s1">&#39;123456&#39;</span><span class="p">,</span>
    <span class="s1">&#39;database-name&#39;</span> <span class="o">=</span> <span class="s1">&#39;mydb&#39;</span><span class="p">,</span>
    <span class="s1">&#39;table-name&#39;</span> <span class="o">=</span> <span class="s1">&#39;products&#39;</span>
  <span class="p">);</span>

<span class="n">Flink</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">orders</span> <span class="p">(</span>
   <span class="n">order_id</span> <span class="nb">INT</span><span class="p">,</span>
   <span class="n">order_date</span> <span class="k">TIMESTAMP</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
   <span class="n">customer_name</span> <span class="n">STRING</span><span class="p">,</span>
   <span class="n">price</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
   <span class="n">product_id</span> <span class="nb">INT</span><span class="p">,</span>
   <span class="n">order_status</span> <span class="nb">BOOLEAN</span><span class="p">,</span>
   <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="k">NOT</span> <span class="n">ENFORCED</span>
 <span class="p">)</span> <span class="k">WITH</span> <span class="p">(</span>
   <span class="s1">&#39;connector&#39;</span> <span class="o">=</span> <span class="s1">&#39;mysql-cdc&#39;</span><span class="p">,</span>
   <span class="s1">&#39;hostname&#39;</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
   <span class="s1">&#39;port&#39;</span> <span class="o">=</span> <span class="s1">&#39;3306&#39;</span><span class="p">,</span>
   <span class="s1">&#39;username&#39;</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
   <span class="s1">&#39;password&#39;</span> <span class="o">=</span> <span class="s1">&#39;123456&#39;</span><span class="p">,</span>
   <span class="s1">&#39;database-name&#39;</span> <span class="o">=</span> <span class="s1">&#39;mydb&#39;</span><span class="p">,</span>
   <span class="s1">&#39;table-name&#39;</span> <span class="o">=</span> <span class="s1">&#39;orders&#39;</span>
 <span class="p">);</span>

<span class="n">Flink</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">shipments</span> <span class="p">(</span>
   <span class="n">shipment_id</span> <span class="nb">INT</span><span class="p">,</span>
   <span class="n">order_id</span> <span class="nb">INT</span><span class="p">,</span>
   <span class="n">origin</span> <span class="n">STRING</span><span class="p">,</span>
   <span class="n">destination</span> <span class="n">STRING</span><span class="p">,</span>
   <span class="n">is_arrived</span> <span class="nb">BOOLEAN</span><span class="p">,</span>
   <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">shipment_id</span><span class="p">)</span> <span class="k">NOT</span> <span class="n">ENFORCED</span>
 <span class="p">)</span> <span class="k">WITH</span> <span class="p">(</span>
   <span class="s1">&#39;connector&#39;</span> <span class="o">=</span> <span class="s1">&#39;postgres-cdc&#39;</span><span class="p">,</span>
   <span class="s1">&#39;hostname&#39;</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
   <span class="s1">&#39;port&#39;</span> <span class="o">=</span> <span class="s1">&#39;5432&#39;</span><span class="p">,</span>
   <span class="s1">&#39;username&#39;</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
   <span class="s1">&#39;password&#39;</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
   <span class="s1">&#39;database-name&#39;</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
   <span class="s1">&#39;schema-name&#39;</span> <span class="o">=</span> <span class="s1">&#39;public&#39;</span><span class="p">,</span>
   <span class="s1">&#39;table-name&#39;</span> <span class="o">=</span> <span class="s1">&#39;shipments&#39;</span>
 <span class="p">);</span>
</pre></div>
</div>
<p>Finally, create <code class="docutils literal notranslate"><span class="pre">enriched_orders</span></code> table that is used to load data to the Elasticsearch.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Flink SQL</span>
<span class="n">Flink</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">enriched_orders</span> <span class="p">(</span>
   <span class="n">order_id</span> <span class="nb">INT</span><span class="p">,</span>
   <span class="n">order_date</span> <span class="k">TIMESTAMP</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
   <span class="n">customer_name</span> <span class="n">STRING</span><span class="p">,</span>
   <span class="n">price</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
   <span class="n">product_id</span> <span class="nb">INT</span><span class="p">,</span>
   <span class="n">order_status</span> <span class="nb">BOOLEAN</span><span class="p">,</span>
   <span class="n">product_name</span> <span class="n">STRING</span><span class="p">,</span>
   <span class="n">product_description</span> <span class="n">STRING</span><span class="p">,</span>
   <span class="n">shipment_id</span> <span class="nb">INT</span><span class="p">,</span>
   <span class="n">origin</span> <span class="n">STRING</span><span class="p">,</span>
   <span class="n">destination</span> <span class="n">STRING</span><span class="p">,</span>
   <span class="n">is_arrived</span> <span class="nb">BOOLEAN</span><span class="p">,</span>
   <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="k">NOT</span> <span class="n">ENFORCED</span>
 <span class="p">)</span> <span class="k">WITH</span> <span class="p">(</span>
     <span class="s1">&#39;connector&#39;</span> <span class="o">=</span> <span class="s1">&#39;elasticsearch-7&#39;</span><span class="p">,</span>
     <span class="s1">&#39;hosts&#39;</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:9200&#39;</span><span class="p">,</span>
     <span class="s1">&#39;index&#39;</span> <span class="o">=</span> <span class="s1">&#39;enriched_orders&#39;</span>
 <span class="p">);</span>
</pre></div>
</div>
</section>
<section id="enriching-orders-and-load-to-elasticsearch">
<h2>Enriching orders and load to ElasticSearch<a class="headerlink" href="#enriching-orders-and-load-to-elasticsearch" title="Permalink to this headline">¶</a></h2>
<p>Use Flink SQL to join the <code class="docutils literal notranslate"><span class="pre">order</span></code> table with the <code class="docutils literal notranslate"><span class="pre">products</span></code> and <code class="docutils literal notranslate"><span class="pre">shipments</span></code> table to enrich orders and write to the Elasticsearch.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Flink SQL</span>
<span class="n">Flink</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">enriched_orders</span>
 <span class="k">SELECT</span> <span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">description</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">shipment_id</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">destination</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">is_arrived</span>
 <span class="k">FROM</span> <span class="n">orders</span> <span class="k">AS</span> <span class="n">o</span>
 <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">products</span> <span class="k">AS</span> <span class="n">p</span> <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">product_id</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">id</span>
 <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">shipments</span> <span class="k">AS</span> <span class="n">s</span> <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">order_id</span><span class="p">;</span>
</pre></div>
</div>
<p>Now, the enriched orders should be shown in Kibana.
Visit <a class="reference external" href="http://localhost:5601/app/kibana#/management/kibana/index_pattern">http://localhost:5601/app/kibana#/management/kibana/index_pattern</a> to create an index pattern <code class="docutils literal notranslate"><span class="pre">enriched_orders</span></code>.</p>
<p><img alt="Create Index Pattern" src="../../_images/kibana-create-index-pattern.png" /></p>
<p>Visit <a class="reference external" href="http://localhost:5601/app/kibana#/discover">http://localhost:5601/app/kibana#/discover</a> to find the enriched orders.</p>
<p><img alt="Find enriched Orders" src="../../_images/kibana-detailed-orders.png" /></p>
<p>Next, do some change in the databases, and then the enriched orders shown in Kibana will be updated after each step in real time.</p>
<ol>
<li><p>Insert a new order in MySQL</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--MySQL</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">orders</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="k">default</span><span class="p">,</span> <span class="s1">&#39;2020-07-30 15:22:00&#39;</span><span class="p">,</span> <span class="s1">&#39;Jark&#39;</span><span class="p">,</span> <span class="mi">29</span><span class="p">.</span><span class="mi">71</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Insert a shipment in Postgres</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--PG</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">shipments</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="mi">10004</span><span class="p">,</span><span class="s1">&#39;Shanghai&#39;</span><span class="p">,</span><span class="s1">&#39;Beijing&#39;</span><span class="p">,</span><span class="k">false</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Update the order status in MySQL</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--MySQL</span>
<span class="k">UPDATE</span> <span class="n">orders</span> <span class="k">SET</span> <span class="n">order_status</span> <span class="o">=</span> <span class="k">true</span> <span class="k">WHERE</span> <span class="n">order_id</span> <span class="o">=</span> <span class="mi">10004</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Update the shipment status in Postgres</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--PG</span>
<span class="k">UPDATE</span> <span class="n">shipments</span> <span class="k">SET</span> <span class="n">is_arrived</span> <span class="o">=</span> <span class="k">true</span> <span class="k">WHERE</span> <span class="n">shipment_id</span> <span class="o">=</span> <span class="mi">1004</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Delete the order in MySQL</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--MySQL</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">orders</span> <span class="k">WHERE</span> <span class="n">order_id</span> <span class="o">=</span> <span class="mi">10004</span><span class="p">;</span>
</pre></div>
</div>
<p>The changes of enriched orders in Kibana are as follows:
<img alt="Enriched Orders Changes" src="../../_images/kibana-detailed-orders-changes.gif" /></p>
</li>
</ol>
</section>
<section id="clean-up">
<h2>Clean up<a class="headerlink" href="#clean-up" title="Permalink to this headline">¶</a></h2>
<p>After finishing the tutorial, run the following command to stop all containers in the directory of <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker-compose down
</pre></div>
</div>
<p>Run the following command to stop the Flink cluster in the directory of Flink <code class="docutils literal notranslate"><span class="pre">flink-1.13.2</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./bin/stop-cluster.sh
</pre></div>
</div>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="mongodb-tutorial.html" class="btn btn-neutral float-right" title="Demo: MongoDB CDC to Elasticsearch" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2023, Ververica GmbH; Apache Flink, Flink®, Apache®, the squirrel logo, and the Apache feather logo are either registered trademarks or trademarks of The Apache Software Foundation.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  <!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
-->



<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      version: release-2.2
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        
        <dl>
            <dt>Versions</dt>
            
            
            <dd><a href="/flink-cdc-connectors/master/">master</a></dd>
            
            
            
            <dd><a href="/flink-cdc-connectors/release-1.4/">release-1.4</a></dd>
            
            
            
            <dd><a href="/flink-cdc-connectors/release-2.0/">release-2.0</a></dd>
            
            
            
            <dd><a href="/flink-cdc-connectors/release-2.1/">release-2.1</a></dd>
            
            
             <strong> 
            <dd><a href="/flink-cdc-connectors/release-2.2/">release-2.2</a></dd>
             </strong> 
            
            
            <dd><a href="/flink-cdc-connectors/release-2.3/">release-2.3</a></dd>
            
            
            
            <dd><a href="/flink-cdc-connectors/release-2.4/">release-2.4</a></dd>
            
            
        </dl>
        
        
        <hr/>
        Free document hosting provided by <a href="http://www.readthedocs.org">Read the
        Docs</a>.

    </div>
</div>

<!-- Place this tag in your head or just before your close body tag. -->
<script async defer
        src="https://ververica.github.io/flink-cdc-connectors/release-2.2/_static/button.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>